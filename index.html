<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì •ë¶€ ë³µì§€ì§€ì› ì„œë¹„ìŠ¤ ê²€ìƒ‰ê¸°</title>
<style>
/* ===== Design System: Dark/Gray Sleek ===== */
:root{
  --bg:#0b0c0e;        /* page background */
  --surface:#111317;    /* cards, panels */
  --surface-2:#16181d;  /* inputs */
  --border:#262a33;
  --text:#f2f4f8;       /* primary text */
  --muted:#8b92a1;      /* secondary text */
  --brand:#9BA3AF;      /* desaturated gray-green accent */
  --accent:#2dd4bf;     /* action accent for focus/hover */
  --ok:#22c55e; --err:#ef4444; --warn:#f59e0b;
}
/* Light fallback (if user prefers light) */
@media (prefers-color-scheme: light){
  :root{ --bg:#f7f8f9; --surface:#ffffff; --surface-2:#f9fafb; --border:#e5e7eb; --text:#0b1220; --muted:#647085; --brand:#4B5563; --accent:#2dd4bf; }
}
html,body{height:100%}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:15px/1.6 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", Pretendard, Noto Sans KR, sans-serif}
.container{max-width:980px;margin:0 auto;padding:16px}
.header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(120%) blur(6px);background:color-mix(in oklab,var(--bg) 82%, transparent);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 16px;border-radius:0 0 16px 16px}
.logo{font-weight:800;color:var(--text);letter-spacing:0.2px}
.theme-toggle{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);background:var(--surface-2);color:var(--text);padding:8px 12px;border-radius:999px;font-size:13px;cursor:pointer}
.theme-toggle:focus-visible{outline:2px solid var(--accent);outline-offset:2px}

.select, .btn{padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:#2b3036;color:#f8fafc;cursor:pointer;font-size:14px;box-shadow:0 1px 0 rgba(255,255,255,.04) inset}
.select{min-width:160px}
.select:focus-visible, .btn:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
.btn{transition:transform .06s ease}
.btn:active{transform:scale(.98)}
.btn.primary{background:#3a3f47;border-color:#3a3f47;color:#ffffff}
.btn.primary:hover{background:#2c3138}

.filters{display:flex;gap:8px;flex-wrap:nowrap;overflow-x:auto;margin:12px 0;padding-bottom:6px}
.filters::-webkit-scrollbar{height:8px}
.filters::-webkit-scrollbar-thumb{background:var(--border);border-radius:999px}
.controls{display:flex;gap:8px;margin-top:8px}
.controls input[type="search"]{flex:1;padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:var(--surface-2);color:var(--text)}

.grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px;margin-top:14px}
@media (max-width:1024px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr));} }
@media (max-width:640px){ .grid{grid-template-columns:1fr;} .select{min-width:220px} }

.card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.card h3{margin:0 0 6px;font-size:17px;line-height:1.3}
.meta{font-size:12px;color:var(--muted);margin-bottom:8px}
.kv{font-size:13px;color:var(--text);background:var(--surface-2);border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:8px}
.kv b{display:inline-block;width:92px;color:#cdd3dd}
.actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.footer{margin:16px 0 4px;color:var(--muted);font-size:12px;text-align:center}
.empty{padding:24px;border:1px dashed var(--border);border-radius:16px;background:var(--surface);color:var(--muted);text-align:center}
.loader{display:none;margin-top:12px;color:var(--muted)}
.loader.show{display:block}
.badge{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border)}
.badge.y{background:color-mix(in oklab, var(--ok) 20%, var(--surface));color:#16a34a}
.badge.n{background:color-mix(in oklab, var(--err) 14%, var(--surface));color:#ef4444}
.diag{margin-top:12px;border:1px solid var(--border);border-radius:12px;background:var(--surface)}
.diag summary{cursor:pointer;padding:10px 12px;font-weight:600;color:#cbd5e1}
.diag pre{margin:0;padding:12px;white-space:pre-wrap;word-break:break-all;background:var(--surface-2);color:#d1d5db}

/* Touch-friendly tap targets on mobile */
@media (max-width:480px){
  .btn, .select { padding:14px 16px; font-size:15px; }
  .header{padding:8px 12px}
}

/* Reduced motion preference */
@media (prefers-reduced-motion: reduce){
  .btn{transition:none}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="logo">ì •ë¶€ ë³µì§€ì§€ì› ì„œë¹„ìŠ¤ ê²€ìƒ‰ê¸°</div>
<button id="themeBtn" class="theme-toggle" aria-label="í…Œë§ˆ ì „í™˜">ğŸŒ— í…Œë§ˆ</button>
  </div>

  <!-- ì¹´í…Œê³ ë¦¬ ìš°ì„  í”Œë¡œìš° -->
  <div class="filters">
    <select id="lifeArray" class="select" title="ì—°ë ¹ëŒ€">
      <option value="">ì—°ë ¹ëŒ€ ì „ì²´</option>
      <option value="001">ì˜ìœ ì•„</option>
      <option value="002">ì•„ë™</option>
      <option value="003">ì²­ì†Œë…„</option>
      <option value="004">ì²­ë…„</option>
      <option value="005">ì¤‘ì¥ë…„</option>
      <option value="006">ë…¸ë…„</option>
      <option value="007">ì„ì‹ Â·ì¶œì‚°</option>
    </select>
    <select id="trgterIndvdlArray" class="select" title="ì§€ì›ëŒ€ìƒ">
      <option value="">ì§€ì›ëŒ€ìƒ ì „ì²´</option>
      <option value="010">ë‹¤ë¬¸í™”Â·íƒˆë¶ë¯¼</option>
      <option value="020">ë‹¤ìë…€</option>
      <option value="030">ë³´í›ˆëŒ€ìƒì</option>
      <option value="040">ì¥ì• ì¸</option>
      <option value="050">ì €ì†Œë“</option>
      <option value="060">í•œë¶€ëª¨Â·ì¡°ì†</option>
    </select>
    <select id="intrsThemaArray" class="select" title="ê´€ì‹¬ì£¼ì œ">
      <option value="">ê´€ì‹¬ì£¼ì œ ì „ì²´</option>
      <option value="010">ì‹ ì²´ê±´ê°•</option>
      <option value="020">ì •ì‹ ê±´ê°•</option>
      <option value="030">ìƒí™œì§€ì›</option>
      <option value="040">ì£¼ê±°</option>
      <option value="050">ì¼ìë¦¬</option>
      <option value="060">ë¬¸í™”Â·ì—¬ê°€</option>
      <option value="070">ì•ˆì „Â·ìœ„ê¸°</option>
      <option value="080">ì„ì‹ Â·ì¶œì‚°</option>
      <option value="090">ë³´ìœ¡</option>
      <option value="100">êµìœ¡</option>
      <option value="110">ì…ì–‘Â·ìœ„íƒ</option>
      <option value="120">ë³´í˜¸Â·ëŒë´„</option>
      <option value="130">ì„œë¯¼ê¸ˆìœµ</option>
      <option value="140">ë²•ë¥ </option>
      <option value="160">ì—ë„ˆì§€</option>
    </select>
    <button id="runBtn" class="btn primary" title="ì„ íƒ ê¸°ì¤€ìœ¼ë¡œ ì¼ê´„ ê²€ìƒ‰">ğŸ” ì„ íƒìœ¼ë¡œ ê²€ìƒ‰</button>
    <button id="exportBtn" class="btn" title="í˜„ì¬ ê²°ê³¼ë¥¼ XLSXë¡œ ì €ì¥">â¬‡ï¸ ì—‘ì…€(.xlsx)ë¡œ ì¶”ì¶œ</button>
  </div>

    <!-- (ì˜µì…˜) ê³ ê¸‰ê²€ìƒ‰: í‚¤ì›Œë“œ ë³´ì¡° ì…ë ¥ -->
  <details style="margin:0 0 8px;border:1px dashed #d9ddcc;border-radius:12px;background:#fcfdf9">
    <summary style="cursor:pointer;padding:8px 12px;font-weight:600;color:#3b4a2a">ê³ ê¸‰ê²€ìƒ‰ (í‚¤ì›Œë“œ ë³´ì¡°)</summary>
    <div class="controls">
      <input id="q" type="search" style="flex:1;padding:12px 14px;border:1px solid #d9ddcc;border-radius:12px;background:#fff" placeholder="í•„ìš” ì‹œ í‚¤ì›Œë“œë¥¼ ë³´ì¡°ë¡œ ì…ë ¥í•˜ì„¸ìš”." />
      <button id="searchBtn" class="btn">í‚¤ì›Œë“œ ê²€ìƒ‰</button>
    </div>
  </details>

  <div id="loader" class="loader">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  <div id="notice" style="display:none;margin-top:10px;padding:10px;border-radius:10px;border:1px solid #f59e0b;background:#fff7ed;color:#92400e;font-size:13px"></div>
  <div id="results" class="grid"></div>
    <div class="footer">ì •ë³´ ì œê³µ: ë³´ê±´ë³µì§€ë¶€ Â· í•œêµ­ì‚¬íšŒë³´ì¥ì •ë³´ì› (ê³µê³µë°ì´í„°í¬í„¸)</div>
</div>
<script>
// ===== Theme boot =====
(function(){
  try{
    const saved = localStorage.getItem('theme');
    if(saved==='dark') document.documentElement.dataset.theme='dark';
    if(saved==='light') document.documentElement.dataset.theme='light';
  }catch(_){/* ignore */}
})();

// === êµ¬ì„±ê°’ ===
// ğŸ” ì¸ì¦í‚¤: ì¸ì½”ë”©/ë””ì½”ë”© 2ì¢… ëª¨ë‘ ë³´ê´€
// ğŸ” serviceKeyëŠ” í”„ë¡ì‹œ(Cloudflare Worker)ì—ì„œ ì£¼ì…ë©ë‹ˆë‹¤. í´ë¼ì´ì–¸íŠ¸ì— í‚¤ë¥¼ ì ˆëŒ€ ë…¸ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

// ì—”ë“œí¬ì¸íŠ¸ (http/https ëª¨ë‘ ì‹œë„)
const BASE_URL_HTTPS = "https://apis.data.go.kr/B554287/NationalWelfareInformationsV001/NationalWelfarelistV001";
const BASE_URL_HTTP  = "http://apis.data.go.kr/B554287/NationalWelfareInformationsV001/NationalWelfarelistV001";
let USE_PROXY = true;    // CORS íšŒí”¼ ê¸°ë³¸ on (ìš´ì˜ì‹œ ìì²´ í”„ë¡ì‹œ ê¶Œì¥)
let PROXY_URL = "https://muddy-limit-80e4.dynamicjmh.workers.dev/?url="; // Cloudflare Worker í”„ë¡ì‹œ

// === ìœ í‹¸ ===
// Theme toggle
(function(){
  const btn = document.getElementById('themeBtn');
  if(!btn) return;
  btn.addEventListener('click', ()=>{
    const cur = document.documentElement.dataset.theme;
    const next = cur==='dark' ? 'light' : 'dark';
    document.documentElement.dataset.theme = next;
    try{ localStorage.setItem('theme', next); }catch(_){/* noop */}
  });
})();
const $ = (s)=>document.querySelector(s);
function setDiag(txt){ const box=$("#diagBox"); if(box) box.textContent = txt; }
function fmtDate8(yyyymmdd){ if(!yyyymmdd||yyyymmdd.length<8) return yyyymmdd||''; return `${yyyymmdd.slice(0,4)}-${yyyymmdd.slice(4,6)}-${yyyymmdd.slice(6,8)}`; }

// í‚¤ ëª¨ë“œ: ENC (ì¸ì½”ë”©í‚¤ ê·¸ëŒ€ë¡œ), DEC_ENC1 (ë””ì½”ë”©í‚¤ 1íšŒ ì¸ì½”ë”©), DEC_RAW (ë””ì½”ë”©í‚¤ ì›ë¬¸ ê·¸ëŒ€ë¡œ)

function buildUrl(query, baseUrl){
  const u = new URL(baseUrl);
  // serviceKeyëŠ” í”„ë¡ì‹œì—ì„œ ìë™ ì£¼ì…ë¨
  u.searchParams.set("callTp", "L");
  u.searchParams.set("pageNo", "1");
  u.searchParams.set("numOfRows", "50");
  u.searchParams.set("srchKeyCode", "003"); // ì œëª©+ë‚´ìš©
  if(query) u.searchParams.set("searchWrd", query);
  const life = $("#lifeArray").value;
  const trg = $("#trgterIndvdlArray").value;
  const intrs = $("#intrsThemaArray").value;
  if(life) u.searchParams.set("lifeArray", life);
  if(trg) u.searchParams.set("trgterIndvdlArray", trg);
  if(intrs) u.searchParams.set("intrsThemaArray", intrs);
  u.searchParams.set("orderBy", "popular");
  return u.toString();
}

async function fetchData(query){
  const attempts = [
    { base: BASE_URL_HTTPS, label: 'HTTPS' },
    { base: BASE_URL_HTTP,  label: 'HTTP' }
  ];

  const tryUrlForProxy = (raw)=> USE_PROXY && PROXY_URL ? PROXY_URL + encodeURIComponent(raw) : raw;

  let lastText = '', lastStatus = 0, lastCT = '';
  for (let i=0;i<attempts.length;i++){
    const { base, mode, label } = attempts[i];
    const url = buildUrl(query, base);
    $("#loader").classList.add("show");
    setDiag(`ì‹œë„ ${i+1}/${attempts.length}: ${label}
ìš”ì²­ URL: ${url.replace(/(serviceKey=)[^&]+/,'$1***masked***')}
í”„ë¡ì‹œ ì‚¬ìš©: ${USE_PROXY ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'}`);
    try{
      const res = await fetch(tryUrlForProxy(url), { headers: { 'Accept': 'application/xml,text/xml;q=0.9,application/json;q=0.8,*/*;q=0.7' } });
      lastCT = res.headers.get('content-type')||''; lastStatus = res.status; const text = await res.text(); lastText = text;
      setDiag([
        `ì‹œë„ ${i+1}/${attempts.length}: ${label}`,
        `ìš”ì²­ URL: ${url.replace(/(serviceKey=)[^&]+/,'$1***masked***')}`,
        `ìƒíƒœ: ${lastStatus}`,
        `Content-Type: ${lastCT}`,
        `ë³¸ë¬¸(ì• 300ì):`,
        text.slice(0,300)
      ].join('\n'));
      if(!res.ok) throw new Error(`HTTP ${res.status}`);

      if(text.trim().startsWith('<')){
        const doc = new DOMParser().parseFromString(text, 'text/xml');
        const errHeader = doc.getElementsByTagName('cmnMsgHeader')[0] || doc.getElementsByTagName('cmmMsgHeader')[0];
        if(errHeader){
          const reason = errHeader.getElementsByTagName('returnReasonCode')[0]?.textContent||'';
          const authMsg = errHeader.getElementsByTagName('returnAuthMsg')[0]?.textContent||'';
          const errMsg = errHeader.getElementsByTagName('errMsg')[0]?.textContent||'';
          if(String(reason).trim()==='30' || /SERVICE_KEY_IS_NOT_REGISTERED_ERROR/.test(authMsg)){
            // ë‹¤ìŒ ì‹œë„ë¡œ ë„˜ì–´ê°
            continue;
          }
          if(errMsg || authMsg || reason){
            // ë‹¤ë¥¸ ì˜¤ë¥˜ë©´ ë°”ë¡œ í‘œì‹œí•˜ê³  ì¤‘ë‹¨
            setDiag((document.getElementById('diagBox').textContent||'')+`
[API ì‘ë‹µì˜¤ë¥˜] ${errMsg} / ${authMsg} / CODE=${reason}`);
            return [];
          }
        }
        // ì •ìƒ ì‘ë‹µ íŒŒì‹±
        const getTxt = (node, names)=>{ for(const nm of names){ const el=node.getElementsByTagName(nm)[0]; if(el && (el.textContent||'').trim()!=='') return el.textContent; } return ''; };
        let containers = Array.from(doc.getElementsByTagName('servList'));
        if(containers.length===0) containers = Array.from(doc.getElementsByTagName('item'));
        if(containers.length===0){ const servs = Array.from(doc.getElementsByTagName('servNm')); containers = servs.map(s=>s.parentElement).filter(Boolean); }
        const items = containers.map(n=>({
          servNm: getTxt(n,['servNm','svcNm','serviceNm']),
          jurMnofNm: getTxt(n,['jurMnofNm','mngtMofNm','deptNm']),
          servDgst: getTxt(n,['servDgst','summary','servDtlCn']),
          servDtlLink: getTxt(n,['servDtlLink','servDtlLinkAddr','detailLink']),
          lifeArray: getTxt(n,['lifeArray']),
          trgterIndvdlArray: getTxt(n,['trgterIndvdlArray']),
          intrsThemaArray: getTxt(n,['intrsThemaArray']),
          onapPsbltYn: getTxt(n,['onapPsbltYn','onlineApplyYn']),
          sprtCycNm: getTxt(n,['sprtCycNm','supportCycle']),
          svcfrstRegTs: getTxt(n,['svcfrstRegTs','regDate'])
        })).filter(it=> (it.servNm||'').trim()!=='');
        return items;
      }

      try{ const json = JSON.parse(text); return (json?.response?.body?.items?.item)||[]; } catch { /* fallthrough */ }
    }catch(err){
      // ë‹¤ìŒ ì‹œë„ ì§„í–‰
      continue;
    }finally{ $("#loader").classList.remove("show"); }
  }
  // ëª¨ë“  ì‹œë„ ì‹¤íŒ¨ â†’ ë§ˆì§€ë§‰ ì‘ë‹µì„ ë‚¨ê¹€
  setDiag((document.getElementById('diagBox').textContent||'')+`
ëª¨ë“  ì‹œë„ ì‹¤íŒ¨ (ì¸ì¦í‚¤/ì—”ë“œí¬ì¸íŠ¸ ì¡°í•©). ë§ˆì§€ë§‰ ìƒíƒœ=${lastStatus}, CT=${lastCT}`);
  return [];
}

function renderResults(items){
  const results = document.querySelector('#results');
  results.innerHTML = '';
  const notice = document.getElementById('notice');
  const diag = document.getElementById('diagBox').textContent||'';
  if(/Failed to fetch|CORS|blocked|NetworkError/i.test(diag)){
    notice.style.display='block';
    notice.innerHTML = `ë¸Œë¼ìš°ì € CORSë¡œ ì°¨ë‹¨ë˜ì–´ ë°ì´í„° ìˆ˜ì‹ ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜„ì¬ í”„ë¡ì‹œ(${PROXY_URL})ë¥¼ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.`;
  } else { notice.style.display='none'; }

  if(!items || items.length===0){
    results.innerHTML='<div class="empty">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
    return;
  }
  const pickIcon = (it)=>{
    const life = (it.lifeArray||'').trim();
    const intr = (it.intrsThemaArray||'').trim();
    if(/ì˜ìœ ì•„|ë³´ìœ¡/.test(life+intr)) return 'ğŸ§¸';
    if(/ì•„ë™|êµìœ¡/.test(life+intr)) return 'ğŸ“š';
    if(/ì²­ì†Œë…„|ì²­ë…„|ì¼ìë¦¬/.test(life+intr)) return 'ğŸ’¼';
    if(/ì¤‘ì¥ë…„|ë…¸ë…„|ëŒë´„/.test(life+intr)) return 'ğŸ‘µ';
    if(/ì£¼ê±°/.test(life+intr)) return 'ğŸ ';
    if(/ê±´ê°•|ì‹ ì²´ê±´ê°•|ì •ì‹ ê±´ê°•/.test(life+intr)) return 'ğŸ©º';
    if(/ì„œë¯¼ê¸ˆìœµ|ê¸ˆìœµ/.test(life+intr)) return 'ğŸ’³';
    if(/ë²•ë¥ /.test(life+intr)) return 'âš–ï¸';
    if(/ì—ë„ˆì§€/.test(life+intr)) return 'ğŸ”Œ';
    return 'ğŸ›ï¸';
  };
  window.currentItems = items;
  items.forEach(it=>{
    const card=document.createElement('div');
    card.className='card';
    card.style.transition='transform .12s ease, box-shadow .12s ease';
    card.addEventListener('mouseenter',()=>{card.style.transform='translateY(-2px)'; card.style.boxShadow='0 14px 34px rgba(0,0,0,.35)';});
    card.addEventListener('mouseleave',()=>{card.style.transform='none'; card.style.boxShadow='0 10px 30px rgba(0,0,0,.25)';});
    const ynFlag = (it.onapPsbltYn||'').trim().toUpperCase();
    const yn = ynFlag==='Y' ? '<span class="badge y">ì˜¨ë¼ì¸ ì‹ ì²­ ê°€ëŠ¥</span>' : (ynFlag==='N'?'<span class="badge n">ì˜¨ë¼ì¸ ì‹ ì²­ ë¶ˆê°€</span>':'-');
    const link = it.servDtlLink||'#';
    const icon = pickIcon(it);
    card.innerHTML = `
      <h3>${icon} ${it.servNm||''}</h3>
      <div class="meta">${it.jurMnofNm||''}</div>
      <p>${it.servDgst||''}</p>
      <div class="kv">
        <div><b>ì—°ë ¹ëŒ€</b> <span>${it.lifeArray||'-'}</span></div>
        <div><b>ì§€ì›ëŒ€ìƒ</b> <span>${it.trgterIndvdlArray||'-'}</span></div>
        <div><b>ê´€ì‹¬ì£¼ì œ</b> <span>${it.intrsThemaArray||'-'}</span></div>
        <div><b>ì‹ ì²­ì—¬ë¶€</b> <span>${yn}</span></div>
        <div><b>ì§€ì›ì£¼ê¸°</b> <span>${it.sprtCycNm||'-'}</span></div>
        <div><b>ë“±ë¡ì¼</b> <span>${fmtDate8(it.svcfrstRegTs)||'-'}</span></div>
      </div>
      <div class="actions">
        <a class="btn primary" href="${link}" target="_blank" rel="noopener">ìì„¸íˆ ë³´ê¸°</a>
        <button class="btn" onclick="copyLink('${link.replace(/'/g,"&#39;")}')">ë§í¬ ë³µì‚¬</button>
      </div>
    `;
    results.appendChild(card);
  });
}

function copyLink(href){
  if(!href) return;
  navigator.clipboard?.writeText(href).then(()=>{ alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'); });
}

async function doSearch(){
  const qEl=$("#q");
  const q = qEl ? qEl.value.trim() : ""; // í‚¤ì›Œë“œëŠ” ë³´ì¡°
  const items=await fetchData(q||undefined);
  renderResults(items);
}

// ì´ë²¤íŠ¸ ë°”ì¸ë”© (íŒŒì‹± ì—ëŸ¬ ë°©ì§€ í›„ ì •ìƒ ì‘ë™)
$("#runBtn").addEventListener("click", doSearch);
const searchBtn = $("#searchBtn"); if(searchBtn){ searchBtn.addEventListener("click", doSearch); }
const qInput = $("#q"); if(qInput){ qInput.addEventListener("keydown", e=>{ if(e.key === "Enter") doSearch(); }); }


// ===== XLSX ë‚´ë³´ë‚´ê¸° =====
function crc32(str){ const table=(function(){let c,t=[];for(let n=0;n<256;n++){c=n;for(let k=0;k<8;k++){c=((c&1)?(0xEDB88320^(c>>>1)):(c>>>1));}t[n]=c>>>0;}return t;})(); let crc=-1; for(let i=0;i<str.length;i++){const code=str.charCodeAt(i); crc=(crc>>>8)^table[(crc^code)&0xFF];} return (crc^(-1))>>>0; }
function strToUint8(str){ const a=new Uint8Array(str.length); for(let i=0;i<str.length;i++) a[i]=str.charCodeAt(i)&0xFF; return a; }
function dateToDos(t){ const d=new Date(t||Date.now()); const y=d.getFullYear()>1980? d.getFullYear()-1980:0; const time=(d.getHours()<<11)|(d.getMinutes()<<5)|(Math.floor(d.getSeconds()/2)); const date=(y<<9)|((d.getMonth()+1)<<5)|d.getDate(); return {dosTime:time,dosDate:date}; }
function makeZip(files){ const enc=strToUint8; const parts=[]; const central=[]; let offset=0; const now=dateToDos(); files.forEach(f=>{ const data=enc(f.content); const crc=crc32(f.content); const name=enc(f.name); const lf=new Uint8Array(30+name.length); const v=new DataView(lf.buffer); v.setUint32(0,0x04034b50,true); v.setUint16(4,20,true); v.setUint16(6,0,true); v.setUint16(8,0,true); v.setUint16(10,now.dosTime,true); v.setUint16(12,now.dosDate,true); v.setUint32(14,crc,true); v.setUint32(18,data.length,true); v.setUint32(22,data.length,true); v.setUint16(26,name.length,true); v.setUint16(28,0,true); lf.set(name,30); parts.push(lf); offset+=lf.length; parts.push(data); offset+=data.length; const cd=new Uint8Array(46+name.length); const cv=new DataView(cd.buffer); cv.setUint32(0,0x02014b50,true); cv.setUint16(4,20,true); cv.setUint16(6,20,true); cv.setUint16(8,0,true); cv.setUint16(10,0,true); cv.setUint16(12,now.dosTime,true); cv.setUint16(14,now.dosDate,true); cv.setUint32(16,crc,true); cv.setUint32(20,data.length,true); cv.setUint32(24,data.length,true); cv.setUint16(28,name.length,true); cv.setUint16(30,0,true); cv.setUint16(32,0,true); cv.setUint16(34,0,true); cv.setUint16(36,0,true); cv.setUint32(38,0,true); cv.setUint32(42, f._offset = (offset-(lf.length+data.length)), true); cd.set(name,46); central.push(cd); }); const centralSize=central.reduce((s,a)=>s+a.length,0); const centralOffset=offset; central.forEach(c=>{ parts.push(c); offset+=c.length; }); const eocd=new Uint8Array(22); const ev=new DataView(eocd.buffer); ev.setUint32(0,0x06054b50,true); ev.setUint16(4,0,true); ev.setUint16(6,0,true); ev.setUint16(8,files.length,true); ev.setUint16(10,files.length,true); ev.setUint32(12,centralSize,true); ev.setUint32(16,centralOffset,true); ev.setUint16(20,0,true); parts.push(eocd); let total=0; parts.forEach(p=> total+=p.length); const out=new Uint8Array(total); let pos=0; parts.forEach(p=>{ out.set(p,pos); pos+=p.length; }); return new Blob([out], { type:'application/zip' }); }
function buildXlsx(items){ const esc=s=>String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); const rows=[["ì„œë¹„ìŠ¤ëª…","ì†Œê´€ë¶€ì²˜","ìš”ì•½","ì—°ë ¹ëŒ€","ì§€ì›ëŒ€ìƒ","ê´€ì‹¬ì£¼ì œ","ì‹ ì²­ê°€ëŠ¥","ì§€ì›ì£¼ê¸°","ë“±ë¡ì¼","ìƒì„¸ë§í¬"]].concat(items.map(it=>[it.servNm||'',it.jurMnofNm||'',it.servDgst||'',it.lifeArray||'',it.trgterIndvdlArray||'',it.intrsThemaArray||'',(it.onapPsbltYn||''),it.sprtCycNm||'',fmtDate8(it.svcfrstRegTs)||'',it.servDtlLink||''])); let sheet=`<?xml version="1.0" encoding="UTF-8"?>\n<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"><sheetData>`; rows.forEach((r,ri)=>{ sheet+=`<row r="${ri+1}">`; r.forEach((c,ci)=>{ const col=String.fromCharCode(65+(ci%26))+(ri+1); sheet+=`<c r="${col}" t="inlineStr"><is><t>${esc(c)}</t></is></c>`; }); sheet+=`</row>`; }); sheet+=`</sheetData></worksheet>`; const contentTypes=`<?xml version="1.0" encoding="UTF-8"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>
  <Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>
  <Override PartName="/docProps/core.xml" ContentType="application/vnd.openxmlformats-package.core-properties+xml"/>
  <Override PartName="/docProps/app.xml" ContentType="application/vnd.openxmlformats-officedocument.extended-properties+xml"/>
</Types>`; const rels=`<?xml version="1.0" encoding="UTF-8"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="/xl/workbook.xml"/>
</Relationships>`; const wb=`<?xml version="1.0" encoding="UTF-8"?>
<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
  <sheets>
    <sheet name="welfare" sheetId="1" r:id="rId1"/>
  </sheets>
</workbook>`; const wbRels=`<?xml version="1.0" encoding="UTF-8"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>
</Relationships>`; const core=`<?xml version="1.0" encoding="UTF-8"?>
<cp:coreProperties xmlns:cp="http://schemas.openxmlformats.org/package/2006/metadata/core-properties" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:dcterms="http://purl.org/dc/terms/" xmlns:dcmitype="http://purl.org/dc/dcmitype/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <dc:title>welfare_services</dc:title>
  <dc:creator>ìœ„ì ¯</dc:creator>
  <cp:lastModifiedBy>ìœ„ì ¯</cp:lastModifiedBy>
  <dcterms:created xsi:type="dcterms:W3CDTF">${new Date().toISOString()}</dcterms:created>
</cp:coreProperties>`; const app=`<?xml version="1.0" encoding="UTF-8"?>
<Properties xmlns="http://schemas.openxmlformats.org/officeDocument/2006/extended-properties" xmlns:vt="http://schemas.openxmlformats.org/officeDocument/2006/docPropsVTypes">
  <Application>WebApp</Application>
</Properties>`; const files=[{name:"[Content_Types].xml",content:contentTypes},{name:"_rels/.rels",content:rels},{name:"xl/workbook.xml",content:wb},{name:"xl/_rels/workbook.xml.rels",content:wbRels},{name:"xl/worksheets/sheet1.xml",content:sheet},{name:"docProps/core.xml",content:core},{name:"docProps/app.xml",content:app}]; return makeZip(files); }
function exportToXlsx(){ if(!window.currentItems||window.currentItems.length===0){ alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; } const blob=buildXlsx(window.currentItems); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='welfare_services.xlsx'; a.click(); URL.revokeObjectURL(url); }
$("#exportBtn").addEventListener("click", exportToXlsx);
</script>
</body>
</html>
